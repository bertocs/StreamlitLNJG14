import os
import requests
import pandas as pd
from bs4 import BeautifulSoup
from datetime import datetime

URL = "https://www.lapreferente.com/C22314-1/liga-nacional-grupo-14"

HEADERS = {
    "User-Agent": (
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
        "AppleWebKit/537.36 (KHTML, like Gecko) "
        "Chrome/125.0.0.0 Safari/537.36"
    )
}

# Nombres oficiales en orden exacto de la matriz
NOMBRES_OFICIALES = [
    "Atlético Zabal",
    "Calavera C.F.",
    "Córdoba C.F.",
    "Coria C.F.",
    "Fundación Lucena F.C.",
    "Los Califas Balompie",
    "Real Betis Balompie",
    "Real Club Recreativo de Huelva",
    "San Roque Balompie",
    "Atlético Sanluqueño",
    "A.D. Santa Marta",
    "Séneca C.F.",
    "Sevilla F.C.",
    "Sporting Atlético",
    "C.D. Utrera",
    "Xerez Deportivo F.C."
]


def fetch_matrix_limpia():
    """Scrapea la matriz, elimina short names y asigna los nombres oficiales."""
    resp = requests.get(URL, headers=HEADERS)
    resp.raise_for_status()

    soup = BeautifulSoup(resp.text, "lxml")
    div_tabla = soup.find("div", id="divTablaResultados")
    if div_tabla is None:
        raise RuntimeError("No se encontró el div id='divTablaResultados'.")

    table = div_tabla.find("table")
    if table is None:
        raise RuntimeError("No se encontró la tabla dentro del div.")

    df = pd.read_html(str(table), header=None)[0]

    # Eliminar filas/columnas vacías
    df = df.dropna(how="all").dropna(axis=1, how="all").reset_index(drop=True)

    # Eliminar fila 0 (short names columnas) y columna 0 (short names filas)
    resultados = df.iloc[1:, 1:].reset_index(drop=True)

    if resultados.shape != (16, 16):
        raise RuntimeError(f"Forma inesperada: {resultados.shape}")

    resultados.index = NOMBRES_OFICIALES
    resultados.columns = NOMBRES_OFICIALES

    return resultados


def save_excel(df):
    """Guarda la matriz en un archivo Excel en la misma carpeta del script."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    output_path = os.path.join(script_dir, "matriz_lnj_g14.xlsx")

    df.to_excel(output_path, index=True)
    return output_path


def main():
    print("Scrapeando y exportando matriz LNJ G14...\n")
    try:
        matriz = fetch_matrix_limpia()
        out = save_excel(matriz)
        print("Matriz generada con éxito.")
        print("Archivo guardado en:")
        print(out)
    except Exception as e:
        print("ERROR:", e)


if __name__ == "__main__":
    main()
